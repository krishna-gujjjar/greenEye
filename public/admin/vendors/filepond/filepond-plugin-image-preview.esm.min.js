/*!
 * FilePondPluginImagePreview 4.0.5
 * Licensed under MIT, https://opensource.org/licenses/MIT/
 * Please visit https://pqina.nl/filepond/ for details.
 */

/* eslint-disable */

const e={type:"spring",stiffness:.5,damping:.45,mass:10},t=(e,t)=>({x:e,y:t}),i=(e,i)=>t(e.x-i.x,e.y-i.y),a=(e,t)=>Math.sqrt(((e,t)=>((e,t)=>e.x*t.x+e.y*t.y)(i(e,t),i(e,t)))(e,t)),r=(e,i)=>{const a=e,r=i,o=1.5707963267948966-i,n=Math.sin(1.5707963267948966),s=Math.sin(r),c=Math.sin(o),l=Math.cos(o),h=a/n;return t(l*(h*s),l*(h*c))},o=(e,i,o,n)=>{const s=n.x>.5?1-n.x:n.x,c=n.y>.5?1-n.y:n.y,l=2*s*e.width,h=2*c*e.height,p=((e,i)=>{const o=e.width,n=e.height,s=r(o,i),c=r(n,i),l=t(e.x+Math.abs(s.x),e.y-Math.abs(s.y)),h=t(e.x+e.width+Math.abs(c.y),e.y+Math.abs(c.x)),p=t(e.x-Math.abs(c.y),e.y+e.height-Math.abs(c.x));return{width:a(l,h),height:a(l,p)}})(i,o);return Math.max(p.width/l,p.height/h)},n=e=>e.utils.createView({name:"image-bitmap",tag:"canvas",ignoreRect:!0,mixins:{styles:["scaleX","scaleY"]},create:({root:e,props:t})=>{((e,t)=>{(t=t||document.createElement("canvas")).width=e.width,t.height=e.height,t.getContext("2d").drawImage(e,0,0)})(t.image,e.element)}}),s=t=>t.utils.createView({name:"image-clip",tag:"div",ignoreRect:!0,mixins:{apis:["crop","width","height"],styles:["width","height","opacity"],animations:{opacity:{type:"tween",duration:250}}},create:({root:i,props:a})=>{i.ref.image=i.appendChildView(i.createChildView((t=>t.utils.createView({name:"image-canvas-wrapper",tag:"div",ignoreRect:!0,mixins:{apis:["crop","width","height"],styles:["originX","originY","translateX","translateY","scaleX","scaleY","rotateZ"],animations:{originX:e,originY:e,scaleX:e,scaleY:e,translateX:e,translateY:e,rotateZ:e}},create:({root:e,props:i})=>{i.width=i.image.width,i.height=i.image.height,e.ref.image=e.appendChildView(e.createChildView(n(t),{image:i.image}))},write:({root:e,props:t})=>{const{flip:i}=t.crop,{image:a}=e.ref;a.scaleX=i.horizontal?-1:1,a.scaleY=i.vertical?-1:1}}))(t),Object.assign({},a)));const r=i.query("GET_IMAGE_PREVIEW_TRANSPARENCY_INDICATOR");null!==r&&(i.element.dataset.transparencyIndicator="grid"===r?r:"color")},write:({root:e,props:t,shouldOptimize:i})=>{const{crop:a,width:r,height:n}=t;e.ref.image.crop=a;const s={x:0,y:0,width:r,height:n,center:{x:.5*r,y:.5*n}},c={width:e.ref.image.width,height:e.ref.image.height},l={x:a.center.x*c.width,y:a.center.y*c.height},h={x:s.center.x-c.width*a.center.x,y:s.center.y-c.height*a.center.y},p=2*Math.PI+a.rotation%(2*Math.PI),d=a.aspectRatio||c.height/c.width,E=o(c,((e,t)=>{let i=e.width,a=i*t;return a>e.height&&(i=(a=e.height)/t),{x:.5*(e.width-i),y:.5*(e.height-a),width:i,height:a}})(s,d),p,a.center),g=a.zoom*E,_=e.ref.image;if(i)return _.originX=null,_.originY=null,_.translateX=null,_.translateY=null,_.rotateZ=null,_.scaleX=null,void(_.scaleY=null);_.originX=l.x,_.originY=l.y,_.translateX=h.x,_.translateY=h.y,_.rotateZ=p,_.scaleX=g,_.scaleY=g}});let c='<svg width="500" height="200" viewBox="0 0 500 200" preserveAspectRatio="none">\n    <defs>\n        <radialGradient id="gradient-__UID__" cx=".5" cy="1.25" r="1.15">\n            <stop offset=\'50%\' stop-color=\'#000000\'/>\n            <stop offset=\'56%\' stop-color=\'#0a0a0a\'/>\n            <stop offset=\'63%\' stop-color=\'#262626\'/>\n            <stop offset=\'69%\' stop-color=\'#4f4f4f\'/>\n            <stop offset=\'75%\' stop-color=\'#808080\'/>\n            <stop offset=\'81%\' stop-color=\'#b1b1b1\'/>\n            <stop offset=\'88%\' stop-color=\'#dadada\'/>\n            <stop offset=\'94%\' stop-color=\'#f6f6f6\'/>\n            <stop offset=\'100%\' stop-color=\'#ffffff\'/>\n        </radialGradient>\n        <mask id="mask-__UID__">\n            <rect x="0" y="0" width="500" height="200" fill="url(#gradient-__UID__)"></rect>\n        </mask>\n    </defs>\n    <rect x="0" width="500" height="200" fill="currentColor" mask="url(#mask-__UID__)"></rect>\n</svg>',l=!1,h=0;const p=function(){self.onmessage=(e=>{createImageBitmap(e.data.message.file).then(t=>{self.postMessage({id:e.data.id,message:t},[t])})})},d={1:()=>[1,0,0,1,0,0],2:e=>[-1,0,0,1,e,0],3:(e,t)=>[-1,0,0,-1,e,t],4:(e,t)=>[1,0,0,-1,0,t],5:()=>[0,1,1,0,0,0],6:(e,t)=>[0,1,-1,0,t,0],7:(e,t)=>[0,-1,-1,0,t,e],8:e=>[0,-1,1,0,0,e]},E=(e,t,i,a)=>{t=Math.round(t),i=Math.round(i);const r=document.createElement("canvas");r.width=t,r.height=i;const o=r.getContext("2d");return a>=5&&a<=8&&([t,i]=[i,t]),((e,t,i,a)=>{-1!==a&&e.transform.apply(e,d[a](t,i))})(o,t,i,a),o.drawImage(e,0,0,t,i),r},g=e=>/^image/.test(e.type)&&!/svg/.test(e.type),_=e=>{const t=Math.min(10/e.width,10/e.height),i=document.createElement("canvas"),a=i.getContext("2d"),r=i.width=Math.ceil(e.width*t),o=i.height=Math.ceil(e.height*t);a.drawImage(e,0,0,r,o);let n=null;try{n=a.getImageData(0,0,r,o).data}catch(e){return null}const s=n.length;let c=0,l=0,h=0,p=0;for(;p<s;p+=4)c+=n[p]*n[p],l+=n[p+1]*n[p+1],h+=n[p+2]*n[p+2];return{r:c=I(c,s),g:l=I(l,s),b:h=I(h,s)}},I=(e,t)=>Math.floor(Math.sqrt(e/(t/4))),m=t=>{const i=(e=>e.utils.createView({name:"image-preview-overlay",tag:"div",ignoreRect:!0,create:({root:e,props:t})=>{!l&&document.querySelector("base")&&(c=c.replace(/url\(\#/g,"url("+window.location.href.replace(window.location.hash,"")+"#"),l=!0),h++,e.element.classList.add(`filepond--image-preview-overlay-${t.status}`),e.element.innerHTML=c.replace(/__UID__/g,h)},mixins:{styles:["opacity"],animations:{opacity:{type:"spring",mass:25}}}}))(t),a=(t=>t.utils.createView({name:"image-preview",tag:"div",ignoreRect:!0,mixins:{apis:["crop"],styles:["translateY","scaleX","scaleY","opacity"],animations:{scaleX:e,scaleY:e,translateY:e,opacity:{type:"tween",duration:400}}},create:({root:e,props:i})=>{e.ref.clip=e.appendChildView(e.createChildView(s(t),{image:i.image,crop:i.crop}))},write:({root:e,props:t,shouldOptimize:i})=>{const{clip:a}=e.ref,{crop:r,image:o}=t;if(a.crop=r,a.opacity=i?0:1,i)return;const n=o.height/o.width;let s=r.aspectRatio||n;const c=e.rect.inner.width,l=e.rect.inner.height;let h=e.query("GET_IMAGE_PREVIEW_HEIGHT");const p=e.query("GET_IMAGE_PREVIEW_MIN_HEIGHT"),d=e.query("GET_IMAGE_PREVIEW_MAX_HEIGHT"),E=e.query("GET_PANEL_ASPECT_RATIO"),g=e.query("GET_ALLOW_MULTIPLE");E&&!g&&(h=c*E,s=E);let _=null!==h?h:Math.max(p,Math.min(c*s,d)),I=_/s;I>c&&(_=(I=c)*s),_>l&&(_=l,I=l/s),a.width=I,a.height=_}}))(t),r=({root:e,props:t})=>{const i=t.id,r=e.query("GET_ITEM",{id:i});if(!r)return;const o=t.preview,n=r.getMetadata("crop")||{center:{x:.5,y:.5},flip:{horizontal:!1,vertical:!1},zoom:1,rotation:0,aspectRatio:null},s=e.appendChildView(e.createChildView(a,{image:o,crop:n,opacity:0,scaleX:1.15,scaleY:1.15,translateY:15}),e.childViews.length);e.ref.images.push(s),s.opacity=1,s.scaleX=1,s.scaleY=1,s.translateY=0,setTimeout(()=>{e.dispatch("DID_IMAGE_PREVIEW_SHOW",{id:i})},250)},o=({root:e})=>{e.ref.overlayShadow.opacity=1,e.ref.overlayError.opacity=0,e.ref.overlaySuccess.opacity=0},n=({root:e})=>{e.ref.overlayShadow.opacity=.25,e.ref.overlayError.opacity=1};return t.utils.createView({name:"image-preview-wrapper",create:({root:e})=>{e.ref.images=[],e.ref.imageViewBin=[],e.ref.overlayShadow=e.appendChildView(e.createChildView(i,{opacity:0,status:"idle"})),e.ref.overlaySuccess=e.appendChildView(e.createChildView(i,{opacity:0,status:"success"})),e.ref.overlayError=e.appendChildView(e.createChildView(i,{opacity:0,status:"failure"}))},styles:["height"],apis:["height"],write:t.utils.createRoute({DID_IMAGE_PREVIEW_DRAW:({root:e})=>{const t=e.ref.images[e.ref.images.length-1];t.translateY=0,t.scaleX=1,t.scaleY=1,t.opacity=1},DID_IMAGE_PREVIEW_CONTAINER_CREATE:({root:e,props:t})=>{const{id:i}=t,a=e.query("GET_ITEM",i);a&&((e,t)=>{let i=new Image;i.onload=(()=>{const e=i.naturalWidth,a=i.naturalHeight;i=null,t(e,a)}),i.src=e})(URL.createObjectURL(a.file),(t,a)=>{e.dispatch("DID_IMAGE_PREVIEW_CALCULATE_SIZE",{id:i,width:t,height:a})})},DID_FINISH_CALCULATE_PREVIEWSIZE:({root:e,props:i})=>{const{utils:a}=t,{createWorker:o}=a,{id:n}=i,s=e.query("GET_ITEM",n);if(!s)return;const c=URL.createObjectURL(s.file),l=()=>{(e=>new Promise((t,i)=>{const a=new Image;a.crossOrigin="Anonymous",a.onload=(()=>{t(a)}),a.onerror=(e=>{i(e)}),a.src=e}))(c).then(h)},h=t=>{URL.revokeObjectURL(c);const a=(s.getMetadata("exif")||{}).orientation||-1;let{width:o,height:n}=t;a>=5&&a<=8&&([o,n]=[n,o]);const l=window.devicePixelRatio,h=n/o,p=e.rect.element.width,d=e.rect.element.height;let g=0,I=0;I=(g=p)*h,h>1?I=(g=p)*h:g=(I=d)/h,i.preview=E(t,Math.min(o,g*l*4),Math.min(n,I*l*4),a);const m=e.query("GET_IMAGE_PREVIEW_CALCULATE_AVERAGE_IMAGE_COLOR")?_(t):null;s.setMetadata("color",m,!0),"close"in t&&t.close(),e.ref.overlayShadow.opacity=1,r({root:e,props:i})};if((e=>"createImageBitmap"in window&&g(e))(s.file)){const e=o(p);e.post({file:s.file},t=>{e.terminate(),t?h(t):l()})}else l()},DID_UPDATE_ITEM_METADATA:({root:e,props:t,action:i})=>{if("crop"!==i.change.key||!e.ref.images.length)return;const a=e.query("GET_ITEM",{id:t.id});if(!a)return;const o=a.getMetadata("crop"),n=e.ref.images[e.ref.images.length-1];Math.abs(o.aspectRatio-n.crop.aspectRatio)>1e-5?((({root:e})=>{const t=e.ref.images.shift();t.opacity=0,t.translateY=-15,e.ref.imageViewBin.push(t)})({root:e}),r({root:e,props:t})):(({root:e,props:t})=>{const i=e.query("GET_ITEM",{id:t.id});i&&(e.ref.images[e.ref.images.length-1].crop=i.getMetadata("crop"))})({root:e,props:t})},DID_THROW_ITEM_LOAD_ERROR:n,DID_THROW_ITEM_PROCESSING_ERROR:n,DID_THROW_ITEM_INVALID:n,DID_COMPLETE_ITEM_PROCESSING:({root:e})=>{e.ref.overlayShadow.opacity=.25,e.ref.overlaySuccess.opacity=1},DID_START_ITEM_PROCESSING:o,DID_REVERT_ITEM_PROCESSING:o},({root:e})=>{const t=e.ref.imageViewBin.filter(e=>0===e.opacity);e.ref.imageViewBin=e.ref.imageViewBin.filter(e=>e.opacity>0),t.forEach(t=>((e,t)=>{e.removeChildView(t),t._destroy()})(e,t)),t.length=0})})},f=e=>{const{addFilter:t,utils:i}=e,{Type:a,createRoute:r,isFile:o}=i,n=m(e);return t("CREATE_VIEW",e=>{const{is:t,view:i,query:a}=e;if(!t("file")||!a("GET_ALLOW_IMAGE_PREVIEW"))return;const s=(e,t)=>{if(!e.ref.imagePreview)return;let{id:i}=t;const a=e.query("GET_ITEM",{id:i});if(!a)return;const r=e.query("GET_PANEL_ASPECT_RATIO"),o=e.query("GET_ITEM_PANEL_ASPECT_RATIO"),n=e.query("GET_IMAGE_PREVIEW_HEIGHT");if(r||o||n)return;let{imageWidth:s,imageHeight:c}=e.ref;if(!s||!c)return;const l=e.query("GET_IMAGE_PREVIEW_MIN_HEIGHT"),h=e.query("GET_IMAGE_PREVIEW_MAX_HEIGHT"),p=(a.getMetadata("exif")||{}).orientation||-1;if(p>=5&&p<=8&&([s,c]=[c,s]),!g(a.file)){const e=2048/s;s*=e,c*=e}const d=c/s,E=(a.getMetadata("crop")||{}).aspectRatio||d;let _=Math.max(l,Math.min(c,h));const I=e.rect.element.width,m=Math.min(I*E,_);e.dispatch("DID_UPDATE_PANEL_HEIGHT",{id:a.id,height:m})},c=({root:e,props:t})=>{s(e,t)};i.registerWriter(r({DID_RESIZE_ROOT:c,DID_STOP_RESIZE:c,DID_LOAD_ITEM:({root:e,props:t,actions:r})=>{const{id:s}=t,c=a("GET_ITEM",s);if(!c||!o(c.file)||c.archived)return;const l=c.file;if(!(e=>/^image/.test(e.type))(l))return;const h="createImageBitmap"in(window||{}),p=a("GET_IMAGE_PREVIEW_MAX_FILE_SIZE");if(!h&&p&&l.size>p)return;e.ref.imagePreview=i.appendChildView(i.createChildView(n,{id:s}));const d=e.query("GET_IMAGE_PREVIEW_HEIGHT");d&&e.dispatch("DID_UPDATE_PANEL_HEIGHT",{id:c.id,height:d});const E=!h&&l.size>a("GET_IMAGE_PREVIEW_MAX_INSTANT_PREVIEW_FILE_SIZE");e.dispatch("DID_IMAGE_PREVIEW_CONTAINER_CREATE",{id:s},E)},DID_IMAGE_PREVIEW_CALCULATE_SIZE:({root:e,props:t,action:i})=>{e.ref.imageWidth=i.width,e.ref.imageHeight=i.height,s(e,t),requestAnimationFrame(()=>{e.dispatch("DID_FINISH_CALCULATE_PREVIEWSIZE")})},DID_UPDATE_ITEM_METADATA:({root:e,props:t,action:i})=>{"crop"===i.change.key&&s(e,t)}}))}),{options:{allowImagePreview:[!0,a.BOOLEAN],imagePreviewHeight:[null,a.INT],imagePreviewMinHeight:[44,a.INT],imagePreviewMaxHeight:[256,a.INT],imagePreviewMaxFileSize:[null,a.INT],imagePreviewMaxInstantPreviewFileSize:[1e6,a.INT],imagePreviewTransparencyIndicator:[null,a.STRING],imagePreviewCalculateAverageImageColor:[!1,a.BOOLEAN]}}};"undefined"!=typeof window&&void 0!==window.document&&document.dispatchEvent(new CustomEvent("FilePond:pluginloaded",{detail:f}));export default f;
